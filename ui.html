<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0A0A0A;
      color: #ffffff;
      padding: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 400px;
      background: #1A1A1A;
      border-radius: 16px;
      padding: 32px;
      border: 1px solid rgba(245, 184, 0, 0.15);
      box-shadow: 0px 8px 32px rgba(0, 0, 0, 0.4), 0px 0px 1px rgba(245, 184, 0, 0.2);
    }

    .header {
      margin-bottom: 32px;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 36px;
      letter-spacing: -0.5px;
      color: #FFFFFF;
    }

    .subtitle {
      font-size: 14px;
      color: #B8B8B8;
      font-weight: 400;
      line-height: 20px;
    }

    .options {
      margin-bottom: 32px;
    }

    .option-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .option-item:last-child {
      border-bottom: none;
    }

    .option-item:hover {
      background: rgba(245, 184, 0, 0.05);
      margin: 0 -12px;
      padding: 16px 12px;
      border-radius: 8px;
    }

    .option-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .option-item.disabled:hover {
      background: transparent;
      margin: 0;
      padding: 16px 0;
    }

    .option-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .option-icon {
      width: 20px;
      height: 20px;
      color: #F5B800;
      flex-shrink: 0;
    }

    .option-label {
      font-size: 15px;
      font-weight: 500;
      color: #FFFFFF;
      line-height: 22px;
    }

    /* Toggle Switch */
    .toggle {
      width: 52px;
      height: 28px;
      background: #404040;
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .toggle.on {
      background: linear-gradient(135deg, #F5B800 0%, #FFD700 100%);
      box-shadow: 0px 2px 8px rgba(245, 184, 0, 0.3);
    }

    .toggle-knob {
      width: 24px;
      height: 24px;
      background: #FFFFFF;
      border-radius: 12px;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle.on .toggle-knob {
      transform: translateX(24px);
    }

    /* Progress Section */
    .progress-container {
      margin-bottom: 24px;
      display: none;
    }

    .progress-container.show {
      display: block;
    }

    .progress-label {
      font-size: 13px;
      color: #B8B8B8;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #252525;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #F5B800, #FFD700);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* Button */
    .btn-strip {
      width: 100%;
      height: 48px;
      background: linear-gradient(135deg, #F5B800 0%, #FFD700 100%);
      color: #0A0A0A;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0px 4px 16px rgba(245, 184, 0, 0.3);
    }

    .btn-strip:hover {
      transform: translateY(-2px);
      box-shadow: 0px 6px 20px rgba(245, 184, 0, 0.4);
      background: linear-gradient(135deg, #FFD700 0%, #FFE033 100%);
    }

    .btn-strip:active {
      transform: translateY(0px);
      box-shadow: 0px 2px 8px rgba(245, 184, 0, 0.3);
    }

    .btn-strip:disabled {
      background: #404040;
      color: #808080;
      box-shadow: none;
      cursor: not-allowed;
      opacity: 0.5;
      transform: none;
    }

    /* Message Toast */
    .message {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
      box-shadow: 0px 4px 16px rgba(0, 0, 0, 0.3);
    }

    .message.show {
      opacity: 1;
    }

    .message.success {
      background: #10b981;
      color: white;
    }

    .message.error {
      background: #ef4444;
      color: white;
    }

    /* Icons (inline SVG) */
    .icon-component {
      display: inline-block;
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div class="message" id="message"></div>

  <div class="container">
    <div class="header">
      <h1>Strip That Out</h1>
      <div class="subtitle">Select an object or frame</div>
    </div>

    <div class="options" id="options">
      <div class="option-item" onclick="toggleOption('detach')">
        <div class="option-left">
          <svg class="option-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          <div class="option-label">Detach Components</div>
        </div>
        <div class="toggle on" id="toggle-detach">
          <div class="toggle-knob"></div>
        </div>
      </div>

      <div class="option-item" onclick="toggleOption('styles')">
        <div class="option-left">
          <svg class="option-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
          </svg>
          <div class="option-label">Detach Styles</div>
        </div>
        <div class="toggle on" id="toggle-styles">
          <div class="toggle-knob"></div>
        </div>
      </div>

      <div class="option-item" onclick="toggleOption('tokens')">
        <div class="option-left">
          <svg class="option-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="16 18 22 12 16 6"></polyline>
            <polyline points="8 6 2 12 8 18"></polyline>
          </svg>
          <div class="option-label">Detach Variables</div>
        </div>
        <div class="toggle on" id="toggle-tokens">
          <div class="toggle-knob"></div>
        </div>
      </div>
    </div>

    <div class="progress-container" id="progress-container">
      <div class="progress-label" id="progress-label">Processing...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>

    <button class="btn-strip" id="strip-btn" onclick="strip()">Strip That</button>
  </div>

  <script>
    // Global state object
    var pluginState = {
      detachComponents: true,
      unlinkStyles: true,
      unlinkTokens: true,
      isProcessing: false,
      preferencesLoaded: false
    };

    // Apply saved state to UI
    function applyPreferencesToUI() {
      var toggleDetach = document.getElementById('toggle-detach');
      var toggleStyles = document.getElementById('toggle-styles');
      var toggleTokens = document.getElementById('toggle-tokens');
      
      if (!pluginState.detachComponents) {
        toggleDetach.classList.remove('on');
      } else {
        toggleDetach.classList.add('on');
      }
      
      if (!pluginState.unlinkStyles) {
        toggleStyles.classList.remove('on');
      } else {
        toggleStyles.classList.add('on');
      }
      
      if (!pluginState.unlinkTokens) {
        toggleTokens.classList.remove('on');
      } else {
        toggleTokens.classList.add('on');
      }
      
      console.log('Applied preferences to UI:', pluginState);
    }

    function toggleOption(option) {
      if (pluginState.isProcessing) return;
      
      var toggle = document.getElementById('toggle-' + option);
      
      if (option === 'detach') {
        pluginState.detachComponents = !pluginState.detachComponents;
        if (pluginState.detachComponents) {
          toggle.classList.add('on');
        } else {
          toggle.classList.remove('on');
        }
      } else if (option === 'styles') {
        pluginState.unlinkStyles = !pluginState.unlinkStyles;
        if (pluginState.unlinkStyles) {
          toggle.classList.add('on');
        } else {
          toggle.classList.remove('on');
        }
      } else if (option === 'tokens') {
        pluginState.unlinkTokens = !pluginState.unlinkTokens;
        if (pluginState.unlinkTokens) {
          toggle.classList.add('on');
        } else {
          toggle.classList.remove('on');
        }
      }
      
      // Save to backend
      parent.postMessage({
        pluginMessage: {
          type: 'save-preferences',
          preferences: {
            detachComponents: pluginState.detachComponents,
            unlinkStyles: pluginState.unlinkStyles,
            unlinkTokens: pluginState.unlinkTokens
          }
        }
      }, '*');
      
      console.log('Saving preferences:', pluginState);
    }

    function setProcessing(isProcessing) {
      pluginState.isProcessing = isProcessing;
      var btn = document.getElementById('strip-btn');
      var optionItems = document.querySelectorAll('.option-item');
      
      if (isProcessing) {
        btn.disabled = true;
        for (var i = 0; i < optionItems.length; i++) {
          optionItems[i].classList.add('disabled');
        }
      } else {
        btn.disabled = false;
        for (var i = 0; i < optionItems.length; i++) {
          optionItems[i].classList.remove('disabled');
        }
      }
    }

    function updateProgress(message, percent) {
      var container = document.getElementById('progress-container');
      var label = document.getElementById('progress-label');
      var fill = document.getElementById('progress-fill');
      
      container.classList.add('show');
      label.textContent = message;
      fill.style.width = percent + '%';
    }

    function hideProgress() {
      var container = document.getElementById('progress-container');
      container.classList.remove('show');
    }

    function strip() {
      if (pluginState.isProcessing) return;
      
      setProcessing(true);
      updateProgress('Starting...', 0);
      
      parent.postMessage({
        pluginMessage: {
          type: 'strip',
          detachComponents: pluginState.detachComponents,
          unlinkStyles: pluginState.unlinkStyles,
          unlinkTokens: pluginState.unlinkTokens
        }
      }, '*');
    }

    function showMessage(text, type) {
      var messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = 'message ' + type + ' show';
      
      setTimeout(function() {
        messageEl.classList.remove('show');
      }, 3000);
    }

    // Listen for messages from the plugin code
    window.onmessage = function(event) {
      if (event.data.pluginMessage) {
        var msg = event.data.pluginMessage;
        
        if (msg.type === 'preferences-loaded') {
          // Apply loaded preferences
          if (msg.preferences) {
            pluginState.detachComponents = msg.preferences.detachComponents !== undefined ? msg.preferences.detachComponents : true;
            pluginState.unlinkStyles = msg.preferences.unlinkStyles !== undefined ? msg.preferences.unlinkStyles : true;
            pluginState.unlinkTokens = msg.preferences.unlinkTokens !== undefined ? msg.preferences.unlinkTokens : true;
            
            console.log('Loaded preferences from backend:', msg.preferences);
          }
          pluginState.preferencesLoaded = true;
          applyPreferencesToUI();
        } else if (msg.type === 'progress') {
          updateProgress(msg.message, msg.percent);
        } else if (msg.type === 'success') {
          hideProgress();
          setProcessing(false);
          showMessage(msg.message, 'success');
        } else if (msg.type === 'error') {
          hideProgress();
          setProcessing(false);
          showMessage(msg.message, 'error');
        }
      }
    };

    // Wait for DOM to be ready, then apply default UI state
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        applyPreferencesToUI();
      });
    } else {
      applyPreferencesToUI();
    }
  </script>
</body>
</html>
